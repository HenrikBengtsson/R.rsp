<%@meta language="R-vignette" content="--------------------------------
  DIRECTIVES FOR R:

  %\VignetteIndexEntry{Include RSP and other non-Sweave vignettes in R packages}
  %\VignetteAuthor{Henrik Bengtsson}
  %\VignetteKeyword{R, package, vignette, static PDF}
  %\VignetteEngine{R.rsp::rsp}
--------------------------------------------------------------------"%>

<% t0 <- Sys.time() %>

\documentclass[letter,12pt]{article}
\usepackage{xspace}
\usepackage{alltt}

% Adjust margins
\addtolength{\oddsidemargin}{-0.5in}	
\addtolength{\evensidemargin}{-0.5in}	
\addtolength{\textwidth}{1in}
\addtolength{\topmargin}{-0.5in}	
\addtolength{\textheight}{1in}

\newcommand{\keywords}[1]{\footnotesize{\textbf{Keywords: }#1}\xspace}
\newcommand{\pkg}[1]{\textsl{#1}\xspace}
\newcommand{\file}[1]{\textsl{#1}\xspace}
\newcommand{\code}[1]{\texttt{#1}\xspace}
\newcommand{\bs}{$\backslash$}

\newenvironment{rspVerbatim}{\vspace{-\parskip}\begin{alltt}\color{blue}}{\end{alltt}}
\newenvironment{escapeRspVerbatim}{\vspace{-\parskip}\begin{alltt}}{\end{alltt}}


\title{<%@meta name="title"%>}
\author{<%@meta name="author"%>}
\date{<%=format(as.Date(getDate(R.rsp)), format="%B %d, %Y")%>}

\begin{document}

\maketitle
\begin{abstract}
This document describes how to include RSP and other non-Sweave vignettes in R packages such that they appear in the R help system.  
As described in the first part of this document, generic support for vignettes of any format (not only Sweave) was added in R~v3.0.0 making it straightforward to include vignettes of any format including RSP-embedded vignettes.

To include non-Sweave vignettes in packages to be used also in version prior to R~v3.0.0 a different approach is needed.  The last of part of this document describes how this can be done in a way that is forward compatible with the new R~v3.0.0 framework.
\end{abstract}

\keywords{<%@meta name="keywords"%>}

\begin{center}
\emph{This vignette is distributed as part of the \pkg{R.rsp} package, which is available on CRAN.}
\end{center}

\clearpage
\tableofcontents

\clearpage

<%-------------------------------------------------------------------
  BACKGROUND
  -------------------------------------------------------------------%>
\section{Background}
When building an R package, Sweave/LaTeX vignettes are recognized by R, compiled into PDFs, which are listed along with their source in the R help system, e.g. \code{help.start()}.  These package vignettes are also being listed online on the CRAN and Bioconductor package pages.


<%-------------------------------------------------------------------
  R v3.0.0 and beyond
  -------------------------------------------------------------------%>
\section{Vignettes in R v3.0.0 and beyond}
Starting with R~v3.0.0, it is possible to include vignettes of any vignette format in R packages (not only Sweave).  This is handled via a so called \emph{vignette engine} mechanism that utilizes so called \emph{vignette builder} packages such as \pkg{R.rsp}, \pkg{knitr} and \pkg{noweb}.  
For instance, a package that wish to include RSP vignettes using the \pkg{R.rsp} package, should add the following to its \file{DESCRIPTION} file
{\begin{verbatim}
Suggests: R.rsp (>= 0.9.9)
VignetteBuilder: R.rsp
\end{verbatim}}
and the following to each of the RSP vignettes (typically as part of an RSP comment)
{\begin{verbatim}
%\VignetteEngine{R.rsp::rsp}
\end{verbatim}}
This will cause all \file{*.rsp} vignettes to be compiled and part of the package.  Similar approaches can used for other types of vignettes, e.g. knitr and noweb.  It is also possible to use a mix of vignette formats in the same package.  For more details on how vignette are included in packages, see Section `Writing package vignettes' of `Writing R Extensions' part of your R installation (for instance via \code{help.start()}).


<%-------------------------------------------------------------------
  Prior to R v3.0.0
  -------------------------------------------------------------------%>
\section{Vignettes before R v3.0.0}
The instructions given in this section are intended for packages that are to be built and installed on R systems prior to R v3.0.0.  They are such they are forward compatible with the recent R~v3.0.0 vignette framework.  This makes it particularly easy to include vignettes in packages that are supposed to support both newer and older versions of R.

\begin{center}
\emph{If your package is only intended for R~v3.0.0 and beyond, none of the below applies.}
\end{center}


<%-------------------------------------------------------------------
  USING THE DEFAULT R FRAMEWORK
  -------------------------------------------------------------------%>
\subsection{Using the default R framework}
Unfortunately, in versions R~v2.14.0 to R~v2.15.3, static PDFs are not recognized and therefore not listed.  Same is true for other PDFs that are dynamically generated during build by other means, e.g. RSP-embedded LaTeX documents.  Fortunately, there is a framework to include also non-Sweave vignettes, as explained next.


\subsubsection{Include static PDFs}
\label{secStaticPDF}
Assume you have a static PDF named \file{manual.pdf} that you wish to include in your package.  Then place it in the \file{inst/doc/} directory of the package and create a corresponding \file{manual.Rnw} stub (in the same directory) that contains:
\begin{alltt}
%{\bs}VignetteIndexEntry\{User manual\}
{\bs}documentclass\{article\}
{\bs}begin\{document\}
...
{\bs}end\{document\}
\end{alltt}
The above is a minimal valid Sweave document that is recognized by the R build system.
This small addition will make the PDF vignette appear when calling \code{browseVignettes()} as well as in the `Overview of user guides and package vignettes' section of the package HTML help page (via \code{help.start()}).  The drawback is that also the above dummy \file{manual.Rnw} will be listed.


<%-------------------------------------------------------------------
  RSP VIGNETTES
  -------------------------------------------------------------------%>
\subsection{Using the extended framework of the R.rsp package}
<% pathMk <- file.path("doc", "templates", fsep="/"); %>
In this subsection, we describe how to dynamically build and include non-Sweave vignettes, such as, but not limited to, RSP-embedded LaTeX vignettes.  In order to do this, a customized \file{Makefile} needs to be added to the package's \file{inst/doc/} directory.  The Makefile is available in the \pkg{R.rsp} package (see Appendix for its content).  You can copy it to the current directory by:
\begin{verbatim}
pathname <- system.file("<%=pathMk%>/Makefile", package="R.rsp")
file.copy(pathname, to=".")
\end{verbatim}
This Makefile, which does not have to be edited, utilizes a few utility functions that are available in the \pkg{R.rsp} package.  Note that the Makefile and the utility functions are independent of the RSP markup language why it can also be used for other vignette formats.
The use of a custom \file{inst/doc/Makefile} is described in Section `Writing package vignettes' of `Writing R Extensions'.


\subsubsection{Improved HTML overview of vignettes}
By default, the R HTML help system will list links to the PDF and the Sweave source of the vignettes.  This means that above approach for including static PDFs in a package will also list the Rnw stub in this listing.
As explained in `Writing R Extensions', it is possible to override this by providing a custom \file{inst/doc/index.html} file.
It can be tedious the manually edit the \file{index.html} file.  For this reason, if the \file{index.html} file is missing, then the above \file{Makefile} automatically builds one and populates it with the PDF and source files available according to what the vignette files specify (see also below).


\subsubsection{Include RSP-embedded LaTeX vignettes}
\label{secRSPVignette}
Assume you have an RSP-embedded LaTeX vignette named \file{manual.tex.rsp} that you wish to automatically build and have the PDF and the source being include in your package.  In order for this to happen, it must be contain \code{{\bs}Vignette*\{\}} markup as illustrated below:
\begin{alltt}
%{\bs}VignetteIndexEntry\{User manual\}
%{\bs}VignetteEngine\{R.rsp::rsp\}
{\bs}documentclass\{article\}
{\bs}begin\{document\}
...
{\bs}end\{document\}
\end{alltt}
Make sure these statements are given as LaTeX-style comments in your vignette source document.
The \code{{\bs}VignetteIndexEntry\{\}} markup sets the title of the vignette as it will appear in the R vignette index.
The \code{{\bs}VignetteEngine\{\}} markup specifies which vignette engine to use for compiling this vignette source file.  This markup is actually only available in R~v3.0.0, but we use it here too and somewhat imitates its behavior such that it works in any version of R.  This is all taken care of by the \pkg{R.rsp} package.

<%--
\subsubsection{Include non-RSP non-Sweave vignettes}
\label{secNonRSPVignette}
Again, note that this solution is non-specific to RSP vignettes and can be used by vignettes of any format.
In order for this to work in R prior to R~v3.0.0, you also have to specify add a \code{enginesMap.R} file to \code{inst/doc/} that looks like:
{\scriptsize\begin{verbatim}
<%=
pathname <- system.file(pathMk, "enginesMap.R", package="R.rsp");
bfr <- readLines(pathname, warn=FALSE);
paste(bfr, collapse="\n");
%>
\end{verbatim}}
When building vignettes via the Makefile, this file will be sourced to define vignette compile functions that have names equal to the ones specified by the \code{{\bs}VignetteEngine\{\}} statements in your vignettes.
--%>



<%-------------------------------------------------------------------
  APPENDIX
  -------------------------------------------------------------------%>
\clearpage
\section*{Appendix}
\subsection*{The customized Makefile}
\label{appMakefile}
The customized Makefile that builds non-Sweave vignettes and missing \file{/inst/doc/index.html} files is available in \pkg{R.rsp} package directory \file{<%=pathMk%>/}.  It should be copied ``as is'' to \file{inst/doc/} of your package.  Its content is:
{\scriptsize\begin{verbatim}
<%=
pathname <- system.file(pathMk, "Makefile", package="R.rsp");
bfr <- readLines(pathname, warn=FALSE);
rr <- grep("^# HISTORY", bfr);
if (length(rr) > 0) {
  bfr <- bfr[1:(rr-2L)];
}
bfr <- gsub("\t", "    ", bfr, fixed=TRUE);
paste(bfr, collapse="\n");
%>
\end{verbatim}}

\subsection*{Example of .Rinstignore}
\label{appMakefile}
To exclude certain vignette-related files from the R \emph{installation} (but not from the build), one can add a \file{.Rinstignore} to the top-level directory of the package specifying which files to be excluded.  An example of such a file is available in \pkg{R.rsp} package directory \file{<%=pathMk%>/} (it needs to be renamed to start with a period).  Its content is:
{\scriptsize\begin{verbatim}
<%=
pathname <- system.file(pathMk, "Rinstignore", package="R.rsp");
bfr <- readLines(pathname, warn=FALSE);
rr <- grep("^# HISTORY", bfr);
if (length(rr) > 0) {
  bfr <- bfr[1:(rr-2L)];
}
bfr <- gsub("\t", "    ", bfr, fixed=TRUE);
paste(bfr, collapse="\n");
%>
\end{verbatim}}

\subsection*{The files used for creating this document}
\label{appThisRnw}
This document was created the RSP-embedded LaTeX vignette \file{NonSweaveVignettes.tex.rsp} located in the \file{doc/} package directory of \pkg{R.rsp}.  It can manually be compiled into a PDF as:
\begin{verbatim}
pathname <- system.file("doc/NonSweaveVignettes.tex.rsp", package="R.rsp")
R.rsp::file(pathname)
\end{verbatim}
The generated PDF can then be included into the package as a static PDF (as explained in Section~\ref{secStaticPDF}).
However, in this package we have chosen to build it dynamically during package build, by adding it to \file{inst/doc/} as explained above.

\subsection*{Session information}
<%=toLatex(sessionInfo())%>
This report was automatically generated using \code{rfile()} of the R.rsp package.
Total processing time after RSP-to-R translation was <%=dt <- round(Sys.time()-t0, digits=2)%> <%=attr(dt, "units")%>.

\end{document}
