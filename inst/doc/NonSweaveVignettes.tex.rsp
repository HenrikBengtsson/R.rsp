<% t0 <- Sys.time() %>

\documentclass[letter,12pt]{article}
\usepackage{xspace}
\usepackage{alltt}

% Adjust margins
\addtolength{\oddsidemargin}{-0.5in}	
\addtolength{\evensidemargin}{-0.5in}	
\addtolength{\textwidth}{1in}
\addtolength{\topmargin}{-0.5in}	
\addtolength{\textheight}{1in}

\newcommand{\keywords}[1]{\footnotesize{\textbf{Keywords: }#1}\xspace}
\newcommand{\pkg}[1]{\textsl{#1}\xspace}
\newcommand{\file}[1]{\textsl{#1}\xspace}
\newcommand{\code}[1]{\texttt{#1}\xspace}
\newcommand{\bs}{$\backslash$}

\newenvironment{rspVerbatim}{\vspace{-\parskip}\begin{alltt}\color{blue}}{\end{alltt}}
\newenvironment{escapeRspVerbatim}{\vspace{-\parskip}\begin{alltt}}{\end{alltt}}


\title{Include static PDFs and non-Sweave vignettes in an R package}
\author{Henrik Bengtsson}
\date{<%=format(as.Date(getDate(R.rsp)), format="%B %d, %Y")%>}

\begin{document}

\maketitle
\begin{abstract}
This document describes how to include static PDFs and non-Sweave vignettes in an R package such that they appear via \code{browseVignettes()}, \code{help.start()} as well as on CRAN and Bioconductor.
\end{abstract}

\keywords{R, package, vignette, static PDF}

\begin{center}
\emph{This vignette is distributed as part of the \pkg{R.rsp} package, which is available on CRAN.}
\end{center}

\clearpage
\tableofcontents

\clearpage

<%-------------------------------------------------------------------
  BACKGROUND
  -------------------------------------------------------------------%>
\section{Background}
When building an R package, Sweave/LaTeX vignettes are recognized by R, compiled into PDFs, which are listed along with their source in the R help system, e.g. via \code{browseVignettes()} and \code{help.start()}.  These package vignettes are also being listed online on the CRAN and Bioconductor package pages.

Unfortunately, as of R~v2.14.0, static PDFs are not recognized and therefore not listed.  Same is true for other PDFs that are dynamically generated during build by other means, e.g. RSP-embedded LaTeX documents.  Fortunately, there is a framework to include also non-Sweave vignettes, as explained next.


<%-------------------------------------------------------------------
  STATIC PDFS
  -------------------------------------------------------------------%>
\section{Using the default R framework}
\subsection{Include static PDFs}
\label{secStaticPDF}
Assume you have static PDF named \file{manual.pdf} that you wish to include in your package.  Then place it in the \file{inst/doc/} directory of the package and create a corrsponding \file{manual.Rnw} stub (in the same directory) that contains:
\begin{verbatim}
%\VignetteIndexEntry{User manual}
\documentclass{article}
\begin{document}
\end{document}
\end{verbatim}
The above is a minimal valid Sweave document that is recognized by the R build system.
This small addition will make the vignette appear when calling \code{browseVignettes()} as well as in the 'Overview of user guides and package vignettes' section of the package HTML help page (via \code{help.start()}).


<%-------------------------------------------------------------------
  RSP VIGNETTES
  -------------------------------------------------------------------%>
\section{Using the extended framework of the R.rsp package}
In this section, we describe how to dynamically build and include non-Sweave vignettes, such as, but not limited to, RSP-embedded LaTeX vignettes.  In order to do this, a customized \file{Makefile} needs to be added to the package's \file{inst/doc/} directory.  The Makefile is available in the \pkg{R.rsp} package in the installed \file{doc/} directory (see Appendix for its content).  You can copy it to the current directory by:
\begin{verbatim}
pathname <- system.file("doc/Makefile", package="R.rsp")
file.copy(pathname, to=".")
\end{verbatim}
This Makefile utilizes a few utility functions that are available in the \pkg{R.rsp} package.  Note that the Makefile and the utility functions are independent of the RSP markup language\footnote{In the future, we may move the customized Makefile and its utility functions to the \pkg{R.utils} package.}.
The use of a custom \file{inst/doc/Makefile} is described in Section 'Writing package vignettes' of 'Writing R Extensions' (via for instance \code{help.start()}).


\subsection{Improved HTML overview of vignettes}
By default, the R HTML help system will list links to the PDF and the Sweave source of the vignettes.  This means that above approach for including static PDFs in a package will also list the Rnw stub in this listing.
As explained in 'Writing R Extensions', it is possible to override this by providing a custom \file{inst/doc/index.html} file.
It can be tedious the manually edit the \file{index.html} file.  For this reason, if the \file{index.html} file is missing, then the above \file{Makefile} automatically builds one and populates it with the PDF and source files available according to what the Rnw files specify (see also below).


\subsection{Include RSP-embedded LaTeX vignettes}
\label{secRSPVignette}
Assume you have an RSP-embedded LaTeX vignette named \file{manual.tex.rsp} that you wish to automatically build and have the PDF and the source being include in your package.  Then place it in your package \file{inst/doc/} directory and create a corrsponding \file{manual.Rnw} stub containing:

\begin{verbatim}
%\VignetteIndexEntry{User manual}
%\VignetteSource{manual.tex.rsp}
%\VignetteBuild{R.rsp::rsp("manual.tex.rsp")}
\documentclass{article}
\begin{document}
\end{document}
\end{verbatim}
Note that the "commands" \code{{\bs}VignetteSource\{\}} and \code{{\bs}VignetteBuild\{\}} are custom to our setup (recognized by the above Makefile) and are \emph{not} recognized by the R system.
The optional \code{{\bs}VignetteSource\{\}} command specifies which source file should be listed in the \code{help.start()} vignette overview.  If left out or left empty, no source file will be listed.
The \code{{\bs}VignetteBuild\{\}} command specifies what R command to run for building the vignette.  Here we use the \code{rsp()} command of the \pkg{R.rsp} package to build the \file{manual.pdf} from the \file{manual.tex.rsp} file.   The build command can be any R expression, which means that it is possible to compile virtually any type of documents using this technique.



<%-------------------------------------------------------------------
  APPENDIX
  -------------------------------------------------------------------%>
\clearpage
\section*{Appendix}
\subsection*{The customized Makefile}
\label{appMakefile}
The customized Makefile that builds non-Sweave vignettes and missing \file{/inst/doc/index.html} files is available in \pkg{R.rsp} package directory \file{doc/}.  Its content is:
{\scriptsize\begin{verbatim}
<%=
pathname <- system.file("doc/Makefile", package="R.rsp");
bfr <- readLines(pathname);
rr <- grep("^# HISTORY", bfr);
bfr <- bfr[1:(rr-2L)];
paste(bfr, collapse="\n");
%>
\end{verbatim}}

\subsection*{The files used for creating this document}
\label{appThisRnw}
This document was created the RSP-embedded LaTeX vignette \file{NonSweaveVignettes.tex.rsp} located in the \file{/doc/} package directory of \pkg{R.rsp}.  It can manually be compiled into a PDF as:
\begin{verbatim}
library("R.rsp");
pathname <- system.file("doc/NonSweaveVignettes.tex.rsp", package="R.rsp");
rsp(pathname);
\end{verbatim}
The generated PDF can then be included into the package as a static PDF (as explained in Section~\ref{secStaticPDF}).
However, in this package we have choosen to build it dynamically during package build, by adding a \file{doc/NonSweaveVignettes.Rnw} file (as explained in Section~\ref{secRSPVignette}), which contains:
{\scriptsize\begin{verbatim}
<%=
pathname <- system.file("doc/NonSweaveVignettes.Rnw", package="R.rsp");
bfr <- readLines(pathname);
paste(bfr, collapse="\n");
%>
\end{verbatim}}

\subsection*{Session information}
<%=toLatex(sessionInfo())%>
This report was automatically generated using \code{rsp()} of the R.rsp package.
Total processing time after RSP-to-R translation was <%=dt <- round(Sys.time()-t0, digits=2)%> <%=attr(dt, "units")%>.

\end{document}
